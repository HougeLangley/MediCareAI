{/*
  Release Notes v2.0.3 | ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ v2.0.3
  
  Bug fix release for AI diagnosis and privacy logic
  AI è¯Šæ–­å’Œéšç§é€»è¾‘çš„ Bug ä¿®å¤ç‰ˆæœ¬
*/}

# Release v2.0.3 - Bug Fix Release

## ğŸ› Bug Fixes | Bug ä¿®å¤

### 1. Fixed AI Diagnosis Request Type Enum Error
**File:** `backend/app/services/ai_service.py`

**Issue:** Stream diagnosis was using `"comprehensive_diagnosis_stream"` as request_type, but the database enum only allowed `"comprehensive_diagnosis"`. This caused transaction rollback and diagnosis data not being saved.

**Fix:** Changed request_type from `"comprehensive_diagnosis_stream"` to `"comprehensive_diagnosis"`.

**Impact:** 
- âœ… Diagnosis results now properly saved to database
- âœ… Medical case status correctly updated to "completed"
- âœ… Model ID and token usage displayed correctly

---

### 2. Fixed Doctor Comment Permission Logic
**File:** `backend/app/api/api_v1/endpoints/doctor.py`

**Issue:** When submitting comments on cases with `visible_to_doctors=False`, doctors received 404 error even if they were @mentioned.

**Fix:** Updated `create_comment` endpoint to check if the doctor was @mentioned via `DoctorPatientRelation` when `visible_to_doctors=False`.

**Logic:**
- If `visible_to_doctors=True`: Any verified doctor can comment
- If `visible_to_doctors=False`: Only @mentioned doctors can comment

---

### 3. Fixed Case Sharing Privacy Logic
**Files:** 
- `backend/app/api/api_v1/endpoints/ai.py`
- `backend/app/api/api_v1/endpoints/doctor.py`

**Issue:** Confusion about the relationship between "share with doctors" checkbox and @doctor mention.

**Clarified Logic:**

| Patient Action | visible_to_doctors | Who Can See |
|---------------|-------------------|-------------|
| Only â˜‘ï¸ "Share with doctors" | `True` | All certified doctors |
| Only @Doctor Zhao | `False` | Only Doctor Zhao |
| â˜‘ï¸ "Share" + @Doctor Zhao | `True` | All doctors can see, Zhao gets @notification |

**Note:** @mentioning a doctor does NOT restrict visibility. It only sends a notification while maintaining the sharing scope.

---

## ğŸ“ File Changes | æ–‡ä»¶å˜æ›´

```
backend/app/services/ai_service.py          # Line 694: Fixed request_type
backend/app/api/api_v1/endpoints/doctor.py   # Lines 1193-1243: Fixed comment permission
backend/app/api/api_v1/endpoints/ai.py       # Lines 113-202: Clarified sharing logic
```

## ğŸ”„ Deployment | éƒ¨ç½²

Standard Docker deployment:

```bash
git pull
docker compose pull
docker compose up -d
```

## ğŸ“ Notes | å¤‡æ³¨

- All fixes are backward compatible
- No database schema changes required
- Existing data remains valid
